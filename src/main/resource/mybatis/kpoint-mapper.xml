<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.zxxk.dao.KPointDao">

    <select id="getKpointIdsWithQidAndStem" resultType="com.zxxk.data.Data">
        SELECT q.id, qq.stem, qk.pointids FROM question_kpoints qk
        JOIN questions q on qk.questionid = q.id
        JOIN question_qmls qq on qk.questionid = qq.questionid
        WHERE applicationid = 'zujuan' AND courseid = #{courseId}
        AND
        <foreach collection="labelNames" item="labelName" open="(" separator=" OR " close=")">
            find_in_set(#{labelName}, qk.pointids)
        </foreach>
        limit #{start}, #{limit}
    </select>

    <select id="getTop20KpointIds" resultType="String">
        SELECT qk.pointid
        FROM question_kpoint qk
        JOIN questions q ON qk.questionid=q.id
        JOIN question_qmls qq ON q.id=qq.questionid
        WHERE courseid=#{courseId} group by pointid order by count(*) desc
        limit 0, 20
    </select>

    <select id="getAllKpointIds" resultType="String">
        SELECT id
        FROM knowledge_points
        WHERE courseid = #{courseId} AND type != 'NODE'
    </select>

    <select id="getKPointNames" resultType="String">
        SELECT NAME FROM knowledge_points
        WHERE id IN
        <foreach collection="list" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </select>

    <select id="getkpointNamesByQid" resultType="String">
        SELECT kp.name
        FROM question_kpoint qk
        JOIN knowledge_points kp ON kp.id=qk.pointid AND kp.type != 'NODE'
        WHERE qk.questionid = #{questionId}
    </select>

    <select id="getValidLabels" resultType="String">
        SELECT pointid
        FROM question_kpoint qk
        join questions q on qk.questionid=q.id
        where q.courseid=#{courseId}
        group by pointid
        having count(*)>8000
    </select>

    <select id="getKPointsWithCount" resultType="Map">
        SELECT questionid, pointid, count(*) count
        FROM question_kpoint
        GROUP BY pointid
    </select>

    <insert id="saveKPointCount">
        INSERT INTO kpoint_count VALUES
        <foreach collection="list" item="kpointCount" separator=",">
            (#{kpointCount.courseid}, #{kpointCount.pointid}, #{kpointCount.count})
        </foreach>
    </insert>
</mapper>